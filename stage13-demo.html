<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage 13: Hybrid CPU+GPU Architecture Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .webgpu-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            margin-top: 10px;
            font-weight: bold;
        }

        .webgpu-status.available {
            background: #28a745;
        }

        .webgpu-status.unavailable {
            background: #dc3545;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .operations {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .operation-card {
            padding: 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .operation-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .operation-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .operation-card h3 {
            color: #667eea;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .operation-card p {
            color: #666;
            font-size: 0.9em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #667eea;
            text-align: center;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #666;
            font-size: 0.9em;
        }

        .output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .output:empty::before {
            content: '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...';
            color: #888;
            font-style: italic;
        }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        .comparison-card.cpu {
            border-color: #6c757d;
        }

        .comparison-card.gpu {
            border-color: #28a745;
        }

        .comparison-card h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .comparison-card.cpu h3 {
            color: #6c757d;
        }

        .comparison-card.gpu h3 {
            color: #28a745;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #666;
        }

        .metric-value {
            font-weight: bold;
            color: #333;
        }

        .speedup-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            background: #28a745;
            color: white;
            font-weight: bold;
            margin-top: 10px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        canvas {
            border-radius: 8px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Stage 13: Hybrid CPU+GPU Architecture</h1>
            <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –º–µ–∂–¥—É CPU –∏ GPU</p>
            <div id="webgpuStatus" class="webgpu-status">–ü—Ä–æ–≤–µ—Ä–∫–∞ WebGPU...</div>
        </div>

        <div class="content">
            <!-- Initialization -->
            <div class="section">
                <h2>1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã</h2>
                <div class="buttons">
                    <button class="btn-primary" onclick="initializeSystem()">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Hybrid Runtime</button>
                </div>
                <div id="initOutput" class="output"></div>
            </div>

            <!-- Operations -->
            <div class="section">
                <h2>2. –í—ã–±–æ—Ä –æ–ø–µ—Ä–∞—Ü–∏–∏</h2>
                <div class="operations" id="operationsList">
                    <!-- Will be populated dynamically -->
                </div>

                <div class="input-group">
                    <label>–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö (elements):</label>
                    <input type="number" id="dataSize" value="1000000" min="1000" max="10000000">
                </div>

                <div class="buttons">
                    <button class="btn-success" onclick="executeOperation()" id="executeBtn" disabled>–í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</button>
                    <button class="btn-primary" onclick="runBenchmark()" id="benchmarkBtn" disabled>–ó–∞–ø—É—Å—Ç–∏—Ç—å Benchmark (CPU vs GPU)</button>
                </div>
            </div>

            <!-- Results -->
            <div class="section">
                <h2>3. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h2>
                <div id="executionOutput" class="output"></div>
            </div>

            <!-- Comparison -->
            <div class="section">
                <h2>4. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ CPU vs GPU</h2>
                <div class="comparison" id="comparison">
                    <div class="comparison-card cpu">
                        <h3>CPU Execution</h3>
                        <div class="metric">
                            <span class="metric-label">–í—Ä–µ–º—è:</span>
                            <span class="metric-value" id="cpuTime">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Throughput:</span>
                            <span class="metric-value" id="cpuThroughput">-</span>
                        </div>
                    </div>

                    <div class="comparison-card gpu">
                        <h3>GPU Execution</h3>
                        <div class="metric">
                            <span class="metric-label">–í—Ä–µ–º—è:</span>
                            <span class="metric-value" id="gpuTime">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Throughput:</span>
                            <span class="metric-value" id="gpuThroughput">-</span>
                        </div>
                        <div class="speedup-badge" id="speedupBadge" style="display:none;">
                            –£—Å–∫–æ—Ä–µ–Ω–∏–µ: <span id="speedupValue">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="section">
                <h2>5. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h2>
                <div class="stats">
                    <div class="stat-card">
                        <div class="value" id="statTarget">-</div>
                        <div class="label">–í—ã–±—Ä–∞–Ω–æ</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="statConfidence">-</div>
                        <div class="label">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="statOperations">0</div>
                        <div class="label">–û–ø–µ—Ä–∞—Ü–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="statSpeedup">-</div>
                        <div class="label">–°—Ä–µ–¥–Ω–∏–π Speedup</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="stage13-hybrid-architecture.js"></script>
    <script>
        let hybridRuntime = null;
        let selectedOperation = null;
        let operationsExecuted = 0;
        let totalSpeedup = 0;

        const operations = [
            {
                id: 'array.map',
                name: 'Array Map',
                description: '–£–º–Ω–æ–∂–∏—Ç—å –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ 2',
                parallelizability: 0.95,
                computeIntensity: 1.0,
                memoryAccess: 0.1
            },
            {
                id: 'array.reduce.sum',
                name: 'Array Reduce',
                description: '–°—É–º–º–∞ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤',
                parallelizability: 0.85,
                computeIntensity: 1.5,
                memoryAccess: 0.2
            },
            {
                id: 'matrix.multiply',
                name: 'Matrix Multiply',
                description: '–£–º–Ω–æ–∂–µ–Ω–∏–µ –º–∞—Ç—Ä–∏—Ü 512√ó512',
                parallelizability: 0.98,
                computeIntensity: 3.0,
                memoryAccess: 0.3
            },
            {
                id: 'image.filter',
                name: 'Image Filter',
                description: '–°–≤–µ—Ä—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è 1024√ó1024',
                parallelizability: 0.92,
                computeIntensity: 2.5,
                memoryAccess: 0.4
            }
        ];

        // Initialize operations list
        window.addEventListener('load', () => {
            const container = document.getElementById('operationsList');
            operations.forEach(op => {
                const card = document.createElement('div');
                card.className = 'operation-card';
                card.onclick = () => selectOperation(op.id);
                card.innerHTML = `
                    <h3>${op.name}</h3>
                    <p>${op.description}</p>
                `;
                card.id = `op-${op.id}`;
                container.appendChild(card);
            });
        });

        function selectOperation(id) {
            selectedOperation = operations.find(op => op.id === id);

            // Update UI
            document.querySelectorAll('.operation-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(`op-${id}`).classList.add('selected');

            // Enable buttons if system initialized
            if (hybridRuntime && hybridRuntime.initialized) {
                document.getElementById('executeBtn').disabled = false;
                document.getElementById('benchmarkBtn').disabled = false;
            }

            log(`–í—ã–±—Ä–∞–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—è: ${selectedOperation.name}`);
        }

        async function initializeSystem() {
            log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Hybrid Runtime...', 'initOutput');

            try {
                hybridRuntime = new HybridRuntime();
                const result = await hybridRuntime.initialize();

                log(`‚úì –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞`, 'initOutput');
                log(`  WebGPU: ${result.gpuAvailable ? '‚úì –î–æ—Å—Ç—É–ø–µ–Ω' : '‚úó –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}`, 'initOutput');

                if (result.gpuAvailable) {
                    log(`  Adapter: ${result.adapterInfo?.vendor || 'Unknown'}`, 'initOutput');
                    document.getElementById('webgpuStatus').textContent = '‚úì WebGPU Available';
                    document.getElementById('webgpuStatus').className = 'webgpu-status available';
                } else {
                    log(`  Fallback: CPU-only mode`, 'initOutput');
                    log(`  Reason: ${result.error || result.message}`, 'initOutput');
                    document.getElementById('webgpuStatus').textContent = '‚úó WebGPU Unavailable (CPU only)';
                    document.getElementById('webgpuStatus').className = 'webgpu-status unavailable';
                }

                // Enable buttons if operation selected
                if (selectedOperation) {
                    document.getElementById('executeBtn').disabled = false;
                    document.getElementById('benchmarkBtn').disabled = false;
                }

            } catch (error) {
                log(`‚úó –û—à–∏–±–∫–∞: ${error.message}`, 'initOutput');
                console.error(error);
            }
        }

        async function executeOperation() {
            if (!hybridRuntime || !selectedOperation) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏—é');
                return;
            }

            const dataSize = parseInt(document.getElementById('dataSize').value);

            log(`\n–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏: ${selectedOperation.name}`, 'executionOutput');
            log(`–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö: ${dataSize.toLocaleString()} elements`, 'executionOutput');

            try {
                // Prepare data
                const data = prepareData(selectedOperation.id, dataSize);

                // Execute with automatic CPU/GPU selection
                const startTime = performance.now();

                const result = await hybridRuntime.execute({
                    type: selectedOperation.id,
                    dataSize: dataSize,
                    parallelizability: selectedOperation.parallelizability,
                    computeIntensity: selectedOperation.computeIntensity,
                    memoryAccess: selectedOperation.memoryAccess,
                    params: { factor: 2 }
                }, data);

                const duration = performance.now() - startTime;

                log(`\n‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ –Ω–∞: ${result.target}`, 'executionOutput');
                log(`  –í—Ä–µ–º—è: ${duration.toFixed(2)}ms`, 'executionOutput');
                log(`  Throughput: ${(dataSize / duration * 1000).toLocaleString()} ops/sec`, 'executionOutput');

                // Update stats
                document.getElementById('statTarget').textContent = result.target;
                operationsExecuted++;
                document.getElementById('statOperations').textContent = operationsExecuted;

            } catch (error) {
                log(`‚úó –û—à–∏–±–∫–∞: ${error.message}`, 'executionOutput');
                console.error(error);
            }
        }

        async function runBenchmark() {
            if (!hybridRuntime || !selectedOperation) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏—é');
                return;
            }

            const dataSize = parseInt(document.getElementById('dataSize').value);

            log(`\n=== BENCHMARK: ${selectedOperation.name} ===`, 'executionOutput');
            log(`–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö: ${dataSize.toLocaleString()} elements\n`, 'executionOutput');

            try {
                const data = prepareData(selectedOperation.id, dataSize);

                // CPU Benchmark
                log('–ó–∞–ø—É—Å–∫ –Ω–∞ CPU...', 'executionOutput');
                const cpuStart = performance.now();
                await hybridRuntime.cpuExecutor.execute({
                    type: selectedOperation.id,
                    params: { factor: 2 }
                }, data);
                const cpuTime = performance.now() - cpuStart;

                log(`‚úì CPU: ${cpuTime.toFixed(2)}ms`, 'executionOutput');
                document.getElementById('cpuTime').textContent = `${cpuTime.toFixed(2)}ms`;
                document.getElementById('cpuThroughput').textContent =
                    `${(dataSize / cpuTime * 1000).toLocaleString()} ops/sec`;

                // GPU Benchmark (if available)
                if (hybridRuntime.gpuAvailable) {
                    log('–ó–∞–ø—É—Å–∫ –Ω–∞ GPU...', 'executionOutput');
                    const gpuStart = performance.now();
                    await hybridRuntime.gpuExecutor.execute({
                        type: selectedOperation.id,
                        params: { factor: 2 }
                    }, data);
                    const gpuTime = performance.now() - gpuStart;

                    const speedup = cpuTime / gpuTime;

                    log(`‚úì GPU: ${gpuTime.toFixed(2)}ms`, 'executionOutput');
                    log(`\nüöÄ –£—Å–∫–æ—Ä–µ–Ω–∏–µ: ${speedup.toFixed(1)}x`, 'executionOutput');

                    document.getElementById('gpuTime').textContent = `${gpuTime.toFixed(2)}ms`;
                    document.getElementById('gpuThroughput').textContent =
                        `${(dataSize / gpuTime * 1000).toLocaleString()} ops/sec`;

                    document.getElementById('speedupBadge').style.display = 'block';
                    document.getElementById('speedupValue').textContent = `${speedup.toFixed(1)}x`;

                    // Update average speedup
                    totalSpeedup += speedup;
                    operationsExecuted++;
                    document.getElementById('statSpeedup').textContent =
                        `${(totalSpeedup / operationsExecuted).toFixed(1)}x`;

                } else {
                    log('\nGPU –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - benchmark —Ç–æ–ª—å–∫–æ –Ω–∞ CPU', 'executionOutput');
                    document.getElementById('gpuTime').textContent = 'N/A';
                    document.getElementById('gpuThroughput').textContent = 'N/A';
                }

            } catch (error) {
                log(`‚úó –û—à–∏–±–∫–∞ benchmark: ${error.message}`, 'executionOutput');
                console.error(error);
            }
        }

        function prepareData(operationType, size) {
            if (operationType === 'matrix.multiply') {
                const n = Math.sqrt(size);
                const a = new Array(n * n).fill(0).map(() => Math.random());
                const b = new Array(n * n).fill(0).map(() => Math.random());
                return { a, b, M: n, N: n, K: n };
            } else if (operationType === 'image.filter') {
                const n = Math.sqrt(size);
                const image = new Array(n * n).fill(0).map(() => Math.random());
                const kernel = [1/9, 1/9, 1/9, 1/9, 1/9, 1/9, 1/9, 1/9, 1/9]; // 3x3 blur
                return { image, kernel, width: n, height: n };
            } else {
                return new Array(size).fill(0).map((_, i) => i);
            }
        }

        function log(message, outputId = 'executionOutput') {
            const output = document.getElementById(outputId);
            output.textContent += message + '\n';
            output.scrollTop = output.scrollHeight;
        }
    </script>
</body>
</html>
