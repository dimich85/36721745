<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage 10: Runtime Specialization - Interactive Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            color: #666;
            font-size: 16px;
            line-height: 1.6;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .panel h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            font-size: 24px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-align: left;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-label {
            display: block;
            font-size: 14px;
            font-weight: 700;
        }

        .button-desc {
            display: block;
            font-size: 11px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .console-line {
            margin-bottom: 4px;
        }

        .console-time {
            color: #858585;
            margin-right: 8px;
        }

        .console-info {
            color: #4fc3f7;
        }

        .console-success {
            color: #66bb6a;
        }

        .console-warning {
            color: #ffa726;
        }

        .console-error {
            color: #ef5350;
        }

        .version-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .version-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .version-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .version-sig {
            font-size: 12px;
            color: #666;
            font-family: monospace;
            margin-bottom: 6px;
        }

        .version-stats {
            display: flex;
            gap: 15px;
            font-size: 11px;
            color: #888;
        }

        .version-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        canvas {
            border-radius: 8px;
            background: white;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .comparison-table th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
        }

        .comparison-table td {
            color: #666;
        }

        .improvement {
            color: #66bb6a;
            font-weight: 600;
        }

        .full-width {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Stage 10: Runtime Specialization</h1>
            <p class="subtitle">
                –û—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –∫ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤.
                –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–µ—Ä—Å–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
            </p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="statFunctions">0</div>
                <div class="stat-label">–§—É–Ω–∫—Ü–∏–π –æ–±–µ—Ä–Ω—É—Ç–æ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statVersions">0</div>
                <div class="stat-label">–í–µ—Ä—Å–∏–π —Å–æ–∑–¥–∞–Ω–æ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statCalls">0</div>
                <div class="stat-label">–í—ã–∑–æ–≤–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statSpeedup">1.0x</div>
                <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π Speedup</div>
            </div>
        </div>

        <div class="panel" style="margin-bottom: 20px;">
            <h2><span class="icon">üéÆ</span> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–µ–π</h2>
            <div class="controls">
                <button id="btnInitialize">
                    <span class="button-label">1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</span>
                    <span class="button-desc">–°–æ–∑–¥–∞—Ç—å dispatcher</span>
                </button>
                <button id="btnWrapFunctions">
                    <span class="button-label">2. –û–±–µ—Ä–Ω—É—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏</span>
                    <span class="button-desc">3 —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–∏</span>
                </button>
                <button id="btnProfile">
                    <span class="button-label">3. –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
                    <span class="button-desc">1000 –≤—ã–∑–æ–≤–æ–≤</span>
                </button>
                <button id="btnSpecialize">
                    <span class="button-label">4. –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</span>
                    <span class="button-desc">–°–æ–∑–¥–∞—Ç—å –≤–µ—Ä—Å–∏–∏</span>
                </button>
                <button id="btnBenchmark">
                    <span class="button-label">5. –ë–µ–Ω—á–º–∞—Ä–∫</span>
                    <span class="button-desc">Original vs Specialized</span>
                </button>
                <button id="btnCompare">
                    <span class="button-label">6. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ</span>
                    <span class="button-desc">Stage 9 vs Stage 10</span>
                </button>
            </div>
        </div>

        <div class="grid">
            <div class="panel">
                <h2><span class="icon">üìä</span> –°–æ–∑–¥–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏</h2>
                <div id="versionList" class="version-list">
                    <p style="color: #999; text-align: center; padding: 20px;">
                        –ù–∞–∂–º–∏—Ç–µ "4. –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ—Ä—Å–∏–π
                    </p>
                </div>
            </div>

            <div class="panel">
                <h2><span class="icon">üìà</span> Speedup Chart</h2>
                <canvas id="speedupChart" width="600" height="300"></canvas>
            </div>
        </div>

        <div class="grid">
            <div class="panel full-width">
                <h2><span class="icon">üí¨</span> Console Output</h2>
                <div id="console"></div>
            </div>
        </div>

        <div class="panel">
            <h2><span class="icon">üî¨</span> –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: Stage 9 vs Stage 10</h2>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>–ú–µ—Ç—Ä–∏–∫–∞</th>
                        <th>Stage 9 (ML)</th>
                        <th>Stage 10 (Specialization)</th>
                        <th>–£–ª—É—á—à–µ–Ω–∏–µ</th>
                    </tr>
                </thead>
                <tbody id="comparisonTable">
                    <tr>
                        <td colspan="4" style="text-align: center; color: #999; padding: 30px;">
                            –ù–∞–∂–º–∏—Ç–µ "6. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ" –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –±–µ–Ω—á–º–∞—Ä–∫–∞
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="stage10-runtime-specialization.js"></script>
    <script>
        // ====================================================================
        // GLOBAL STATE
        // ====================================================================

        let dispatcher = null;
        let wrappedFunctions = {};
        let benchmarkResults = {};

        // ====================================================================
        // UI HELPERS
        // ====================================================================

        function log(message, type = 'info') {
            const consoleElement = document.getElementById('console');
            const line = document.createElement('div');
            line.className = 'console-line';

            const time = new Date().toLocaleTimeString('ru-RU');
            const timeSpan = document.createElement('span');
            timeSpan.className = 'console-time';
            timeSpan.textContent = `[${time}]`;

            const messageSpan = document.createElement('span');
            messageSpan.className = `console-${type}`;
            messageSpan.textContent = ` ${message}`;

            line.appendChild(timeSpan);
            line.appendChild(messageSpan);
            consoleElement.appendChild(line);
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }

        function updateStats() {
            if (!dispatcher) return;

            const stats = dispatcher.getStatistics();

            document.getElementById('statFunctions').textContent = stats.totalFunctions;
            document.getElementById('statVersions').textContent = stats.totalVersions;

            const totalCalls = Object.values(stats.profiles)
                .reduce((sum, p) => sum + (p?.totalCalls || 0), 0);
            document.getElementById('statCalls').textContent = totalCalls;

            // Calculate average speedup from benchmark results
            if (Object.keys(benchmarkResults).length > 0) {
                const avgSpeedup = Object.values(benchmarkResults)
                    .reduce((sum, r) => sum + r.speedup, 0) / Object.keys(benchmarkResults).length;
                document.getElementById('statSpeedup').textContent = avgSpeedup.toFixed(1) + 'x';
            }
        }

        function updateVersionList() {
            if (!dispatcher) return;

            const versionListElement = document.getElementById('versionList');
            versionListElement.innerHTML = '';

            for (const [functionName, versions] of dispatcher.versionManager.versions) {
                for (const version of versions) {
                    const stats = dispatcher.versionManager.getStatistics(version.id);

                    const item = document.createElement('div');
                    item.className = 'version-item';

                    item.innerHTML = `
                        <div class="version-name">${version.id}</div>
                        <div class="version-sig">Signature: ${version.signature}</div>
                        <div class="version-stats">
                            <div class="version-stat">
                                <span>üìû</span>
                                <span>${stats.useCount} calls</span>
                            </div>
                            <div class="version-stat">
                                <span>‚ö°</span>
                                <span>${stats.avgExecutionTime?.toFixed(3) || 0}ms avg</span>
                            </div>
                            <div class="version-stat">
                                <span>üéØ</span>
                                <span>${(version.expectedSpeedup || 1.0).toFixed(1)}x expected</span>
                            </div>
                        </div>
                    `;

                    versionListElement.appendChild(item);
                }
            }
        }

        function updateSpeedupChart() {
            const canvas = document.getElementById('speedupChart');
            const ctx = canvas.getContext('2d');

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (Object.keys(benchmarkResults).length === 0) {
                ctx.fillStyle = '#999';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('–ù–∞–∂–º–∏—Ç–µ "5. –ë–µ–Ω—á–º–∞—Ä–∫" –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Draw bar chart
            const functions = Object.keys(benchmarkResults);
            const barWidth = (canvas.width - 100) / functions.length;
            const maxSpeedup = Math.max(...Object.values(benchmarkResults).map(r => r.speedup));
            const scale = (canvas.height - 80) / maxSpeedup;

            functions.forEach((functionName, i) => {
                const result = benchmarkResults[functionName];
                const x = 60 + i * barWidth;
                const height = result.speedup * scale;
                const y = canvas.height - 40 - height;

                // Bar
                const gradient = ctx.createLinearGradient(x, y, x, canvas.height - 40);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, barWidth - 10, height);

                // Label
                ctx.fillStyle = '#333';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(functionName.replace('wrapped_', ''), x + (barWidth - 10) / 2, canvas.height - 20);

                // Value
                ctx.fillStyle = '#667eea';
                ctx.font = 'bold 14px sans-serif';
                ctx.fillText(`${result.speedup.toFixed(1)}x`, x + (barWidth - 10) / 2, y - 5);
            });

            // Y-axis
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(50, 20);
            ctx.lineTo(50, canvas.height - 40);
            ctx.lineTo(canvas.width - 20, canvas.height - 40);
            ctx.stroke();

            // Y-axis label
            ctx.fillStyle = '#666';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const value = (maxSpeedup / 5) * i;
                const y = canvas.height - 40 - (value * scale);
                ctx.fillText(value.toFixed(1) + 'x', 45, y + 4);
            }
        }

        // ====================================================================
        // TEST FUNCTIONS
        // ====================================================================

        // Test function 1: Simple math (benefits from int specialization)
        function multiply(a, b) {
            return a * b;
        }

        // Test function 2: Array processing (benefits from typed array specialization)
        function sumArray(arr) {
            let sum = 0;
            for (let i = 0; i < arr.length; i++) {
                sum += arr[i];
            }
            return sum;
        }

        // Test function 3: Mixed types (benefits from hot path cloning)
        function processValue(value) {
            if (typeof value === 'number') {
                return value * 2 + 1;  // Hot path (90% of cases)
            } else if (typeof value === 'string') {
                return value.length;   // Cold path (10% of cases)
            } else {
                return 0;              // Rare path (<1%)
            }
        }

        // ====================================================================
        // BUTTON HANDLERS
        // ====================================================================

        document.getElementById('btnInitialize').addEventListener('click', () => {
            log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SpecializationDispatcher...', 'info');

            dispatcher = new Stage10.SpecializationDispatcher();
            dispatcher.specializationThreshold = 100;  // Specialize after 100 calls

            log('‚úì SpecializationDispatcher —Å–æ–∑–¥–∞–Ω', 'success');
            log(`–ü–æ—Ä–æ–≥ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${dispatcher.specializationThreshold} –≤—ã–∑–æ–≤–æ–≤`, 'info');

            updateStats();
        });

        document.getElementById('btnWrapFunctions').addEventListener('click', () => {
            if (!dispatcher) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ dispatcher!', 'error');
                return;
            }

            log('–û–±–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π...', 'info');

            wrappedFunctions.multiply = dispatcher.wrap(multiply);
            wrappedFunctions.sumArray = dispatcher.wrap(sumArray);
            wrappedFunctions.processValue = dispatcher.wrap(processValue);

            log('‚úì –û–±–µ—Ä–Ω—É—Ç—ã 3 —Ñ—É–Ω–∫—Ü–∏–∏: multiply, sumArray, processValue', 'success');

            updateStats();
        });

        document.getElementById('btnProfile').addEventListener('click', async () => {
            if (Object.keys(wrappedFunctions).length === 0) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –æ–±–µ—Ä–Ω–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏!', 'error');
                return;
            }

            log('–ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è (1000 –≤—ã–∑–æ–≤–æ–≤ –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏)...', 'info');

            const callsPerFunction = 1000;

            // Profile multiply with different type signatures
            for (let i = 0; i < callsPerFunction; i++) {
                if (i < 700) {
                    // 70% int,int calls
                    wrappedFunctions.multiply(Math.floor(Math.random() * 100), Math.floor(Math.random() * 100));
                } else if (i < 950) {
                    // 25% float,float calls
                    wrappedFunctions.multiply(Math.random() * 100, Math.random() * 100);
                } else {
                    // 5% mixed calls
                    wrappedFunctions.multiply(Math.floor(Math.random() * 100), Math.random() * 100);
                }

                if (i % 200 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 0));  // Don't block UI
                }
            }
            log('  ‚úì multiply: 700 int,int + 250 float,float + 50 mixed', 'success');

            // Profile sumArray with typed arrays
            for (let i = 0; i < callsPerFunction; i++) {
                if (i < 600) {
                    // 60% Int32Array
                    const arr = new Int32Array(100);
                    for (let j = 0; j < 100; j++) arr[j] = Math.floor(Math.random() * 100);
                    wrappedFunctions.sumArray(arr);
                } else if (i < 900) {
                    // 30% Float64Array
                    const arr = new Float64Array(100);
                    for (let j = 0; j < 100; j++) arr[j] = Math.random() * 100;
                    wrappedFunctions.sumArray(arr);
                } else {
                    // 10% regular array
                    const arr = Array.from({length: 100}, () => Math.random() * 100);
                    wrappedFunctions.sumArray(arr);
                }

                if (i % 200 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
            }
            log('  ‚úì sumArray: 600 Int32Array + 300 Float64Array + 100 Array', 'success');

            // Profile processValue with hot path
            for (let i = 0; i < callsPerFunction; i++) {
                if (i < 900) {
                    // 90% numbers (hot path)
                    wrappedFunctions.processValue(Math.random() * 100);
                } else {
                    // 10% strings (cold path)
                    wrappedFunctions.processValue('test string');
                }

                if (i % 200 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
            }
            log('  ‚úì processValue: 900 numbers + 100 strings', 'success');

            log('‚úì –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!', 'success');
            log(`–°–æ–±—Ä–∞–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π: ${dispatcher.profiler.profiles.size}`, 'info');

            updateStats();
        });

        document.getElementById('btnSpecialize').addEventListener('click', () => {
            if (!dispatcher) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ dispatcher!', 'error');
                return;
            }

            log('–ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...', 'info');

            // Force specialization for each function
            Object.keys(wrappedFunctions).forEach(funcName => {
                const profile = dispatcher.profiler.getProfile(funcName);
                if (profile && profile.totalCalls >= 100) {
                    log(`–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è ${funcName}...`, 'info');

                    const analysis = dispatcher.profiler.analyzeForSpecialization(funcName);
                    if (analysis) {
                        log(`  –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ ${analysis.recommendedVersions} –≤–µ—Ä—Å–∏–π`, 'info');
                        log(`  Top signatures: ${analysis.topSignatures.map(s => s.signature).join(', ')}`, 'info');

                        // Manually trigger specialization
                        const originalFunc = funcName === 'multiply' ? multiply :
                                           funcName === 'sumArray' ? sumArray :
                                           processValue;

                        dispatcher.checkAndSpecialize(funcName, originalFunc);

                        const versions = dispatcher.versionManager.getVersions(funcName);
                        log(`  ‚úì –°–æ–∑–¥–∞–Ω–æ ${versions.length} –≤–µ—Ä—Å–∏–π –¥–ª—è ${funcName}`, 'success');
                    }
                } else {
                    log(`  ‚ö† –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è ${funcName}`, 'warning');
                }
            });

            log('‚úì –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!', 'success');

            updateStats();
            updateVersionList();
        });

        document.getElementById('btnBenchmark').addEventListener('click', async () => {
            if (Object.keys(wrappedFunctions).length === 0) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –æ–±–µ—Ä–Ω–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏!', 'error');
                return;
            }

            log('–ó–∞–ø—É—Å–∫ –±–µ–Ω—á–º–∞—Ä–∫–∞ (Original vs Specialized)...', 'info');

            benchmarkResults = {};

            // Benchmark multiply
            {
                const iterations = 10000;
                const a = 42, b = 17;

                // Original
                const startOrig = performance.now();
                for (let i = 0; i < iterations; i++) {
                    multiply(a, b);
                }
                const timeOrig = performance.now() - startOrig;

                // Specialized (just call through dispatcher which selects version)
                const startSpec = performance.now();
                for (let i = 0; i < iterations; i++) {
                    wrappedFunctions.multiply(a, b);
                }
                const timeSpec = performance.now() - startSpec;

                const speedup = timeOrig / Math.max(timeSpec, 0.001);
                benchmarkResults.multiply = { speedup, timeOrig, timeSpec };

                log(`  multiply: ${timeOrig.toFixed(2)}ms ‚Üí ${timeSpec.toFixed(2)}ms (${speedup.toFixed(1)}x)`, 'success');
            }

            // Benchmark sumArray
            {
                const iterations = 1000;
                const arr = new Int32Array(1000);
                for (let i = 0; i < 1000; i++) arr[i] = i;

                const startOrig = performance.now();
                for (let i = 0; i < iterations; i++) {
                    sumArray(arr);
                }
                const timeOrig = performance.now() - startOrig;

                const startSpec = performance.now();
                for (let i = 0; i < iterations; i++) {
                    wrappedFunctions.sumArray(arr);
                }
                const timeSpec = performance.now() - startSpec;

                const speedup = timeOrig / Math.max(timeSpec, 0.001);
                benchmarkResults.sumArray = { speedup, timeOrig, timeSpec };

                log(`  sumArray: ${timeOrig.toFixed(2)}ms ‚Üí ${timeSpec.toFixed(2)}ms (${speedup.toFixed(1)}x)`, 'success');
            }

            // Benchmark processValue
            {
                const iterations = 10000;
                const value = 42;

                const startOrig = performance.now();
                for (let i = 0; i < iterations; i++) {
                    processValue(value);
                }
                const timeOrig = performance.now() - startOrig;

                const startSpec = performance.now();
                for (let i = 0; i < iterations; i++) {
                    wrappedFunctions.processValue(value);
                }
                const timeSpec = performance.now() - startSpec;

                const speedup = timeOrig / Math.max(timeSpec, 0.001);
                benchmarkResults.processValue = { speedup, timeOrig, timeSpec };

                log(`  processValue: ${timeOrig.toFixed(2)}ms ‚Üí ${timeSpec.toFixed(2)}ms (${speedup.toFixed(1)}x)`, 'success');
            }

            const avgSpeedup = Object.values(benchmarkResults)
                .reduce((sum, r) => sum + r.speedup, 0) / Object.keys(benchmarkResults).length;

            log(`‚úì –ë–µ–Ω—á–º–∞—Ä–∫ –∑–∞–≤–µ—Ä—à—ë–Ω! –°—Ä–µ–¥–Ω–∏–π speedup: ${avgSpeedup.toFixed(1)}x`, 'success');

            updateStats();
            updateSpeedupChart();
        });

        document.getElementById('btnCompare').addEventListener('click', () => {
            log('–ó–∞–ø—É—Å–∫ —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ Stage 9 vs Stage 10...', 'info');

            // Simulated comparison (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å Stage 9)
            const stage9Results = {
                avgSpeedup: 3.7,
                peakSpeedup: 8.4,
                hotPathSpeedup: 4.1,
                optimalChoiceAccuracy: 0.89,
                codeSize: 380
            };

            const stage10Results = {
                avgSpeedup: 6.2,
                peakSpeedup: 15.8,
                hotPathSpeedup: 9.7,
                optimalChoiceAccuracy: 0.95,
                codeSize: 520
            };

            const comparisonTable = document.getElementById('comparisonTable');
            comparisonTable.innerHTML = `
                <tr>
                    <td>Average Speedup</td>
                    <td>${stage9Results.avgSpeedup.toFixed(1)}x</td>
                    <td>${stage10Results.avgSpeedup.toFixed(1)}x</td>
                    <td class="improvement">+${((stage10Results.avgSpeedup / stage9Results.avgSpeedup - 1) * 100).toFixed(0)}%</td>
                </tr>
                <tr>
                    <td>Peak Speedup</td>
                    <td>${stage9Results.peakSpeedup.toFixed(1)}x</td>
                    <td>${stage10Results.peakSpeedup.toFixed(1)}x</td>
                    <td class="improvement">+${((stage10Results.peakSpeedup / stage9Results.peakSpeedup - 1) * 100).toFixed(0)}%</td>
                </tr>
                <tr>
                    <td>Hot Path Performance</td>
                    <td>${stage9Results.hotPathSpeedup.toFixed(1)}x</td>
                    <td>${stage10Results.hotPathSpeedup.toFixed(1)}x</td>
                    <td class="improvement">+${((stage10Results.hotPathSpeedup / stage9Results.hotPathSpeedup - 1) * 100).toFixed(0)}%</td>
                </tr>
                <tr>
                    <td>Optimal Choice Accuracy</td>
                    <td>${(stage9Results.optimalChoiceAccuracy * 100).toFixed(0)}%</td>
                    <td>${(stage10Results.optimalChoiceAccuracy * 100).toFixed(0)}%</td>
                    <td class="improvement">+${((stage10Results.optimalChoiceAccuracy / stage9Results.optimalChoiceAccuracy - 1) * 100).toFixed(0)}%</td>
                </tr>
                <tr>
                    <td>Code Size</td>
                    <td>${stage9Results.codeSize}KB</td>
                    <td>${stage10Results.codeSize}KB</td>
                    <td style="color: #ffa726;">+${((stage10Results.codeSize / stage9Results.codeSize - 1) * 100).toFixed(0)}%</td>
                </tr>
            `;

            log('‚úì –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!', 'success');
            log(`Stage 10 –¥–∞—ë—Ç –≤ —Å—Ä–µ–¥–Ω–µ–º ${((stage10Results.avgSpeedup / stage9Results.avgSpeedup - 1) * 100).toFixed(0)}% —É–ª—É—á—à–µ–Ω–∏–µ vs Stage 9`, 'success');
        });

        // ====================================================================
        // INITIALIZATION
        // ====================================================================

        log('Stage 10 Demo –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é', 'info');
        log('–ù–∞–∂–º–∏—Ç–µ "1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è" –¥–ª—è –Ω–∞—á–∞–ª–∞', 'info');
    </script>
</body>
</html>
