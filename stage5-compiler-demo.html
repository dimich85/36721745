<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage 5: Real JavaScript to WASM Compiler</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        
        .pipeline {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            border-radius: 10px;
        }
        
        .pipeline-step {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            min-width: 120px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .pipeline-arrow {
            font-size: 2em;
            color: #667eea;
            font-weight: bold;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .panel.full-width {
            grid-column: 1 / -1;
        }
        
        .panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            resize: vertical;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            padding: 12px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            margin: 10px 5px 0 0;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f39c12;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .token-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .token {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-family: 'Consolas', monospace;
        }
        
        .token-keyword {
            background: #e74c3c;
            color: white;
        }
        
        .token-identifier {
            background: #3498db;
            color: white;
        }
        
        .token-number {
            background: #f39c12;
            color: white;
        }
        
        .token-operator {
            background: #9b59b6;
            color: white;
        }
        
        .token-delimiter {
            background: #95a5a6;
            color: white;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-success {
            background: #27ae60;
        }
        
        .status-error {
            background: #e74c3c;
        }
        
        .status-idle {
            background: #95a5a6;
        }
        
        .error-message {
            background: #fee;
            border-left: 4px solid #e74c3c;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            color: #c0392b;
        }
        
        .ast-tree {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.5;
        }
        
        .example-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .example-btn {
            padding: 8px 15px;
            background: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .example-btn:hover {
            background: #bdc3c7;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîß Real JavaScript to WebAssembly Compiler</h1>
            <p class="subtitle">Stage 5: From Source Code to Executable WASM</p>
            
            <div class="pipeline">
                <div class="pipeline-step">üìù<br>Lexer</div>
                <div class="pipeline-arrow">‚Üí</div>
                <div class="pipeline-step">üå≥<br>Parser</div>
                <div class="pipeline-arrow">‚Üí</div>
                <div class="pipeline-step">üîç<br>Type Analyzer</div>
                <div class="pipeline-arrow">‚Üí</div>
                <div class="pipeline-step">‚öôÔ∏è<br>Code Generator</div>
                <div class="pipeline-arrow">‚Üí</div>
                <div class="pipeline-step">üöÄ<br>WASM Module</div>
            </div>
        </header>
        
        <div class="panel full-width">
            <h2>‚úèÔ∏è Input: JavaScript Code</h2>
            
            <div class="example-buttons">
                <button class="example-btn" onclick="loadExample('add')">Simple Addition</button>
                <button class="example-btn" onclick="loadExample('factorial')">Factorial</button>
                <button class="example-btn" onclick="loadExample('fibonacci')">Fibonacci</button>
                <button class="example-btn" onclick="loadExample('complex')">Complex Expression</button>
            </div>
            
            <textarea id="sourceCode" placeholder="Enter your JavaScript code here...">function add(a, b) {
    return a + b;
}</textarea>
            
            <button class="btn-primary" onclick="compileCode()">üîß Compile to WASM</button>
            <button class="btn-secondary" onclick="clearAll()">üóëÔ∏è Clear All</button>
        </div>
        
        <div class="main-content">
            <div class="panel">
                <h2>üìä Compilation Statistics</h2>
                <div id="status">
                    <p><span class="status-indicator status-idle"></span> <span id="status-text">Ready to compile</span></p>
                </div>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-label">Tokens</div>
                        <div class="stat-value" id="stat-tokens">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">AST Nodes</div>
                        <div class="stat-value" id="stat-nodes">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">WAT Lines</div>
                        <div class="stat-value" id="stat-wat">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Errors</div>
                        <div class="stat-value" id="stat-errors">0</div>
                    </div>
                </div>
                <div id="errors" style="margin-top: 20px;"></div>
            </div>
            
            <div class="panel">
                <h2>üéØ Phase 1: Tokens</h2>
                <div id="tokens" class="token-list">
                    <p style="color: #999;">Tokens will appear here after compilation</p>
                </div>
            </div>
            
            <div class="panel">
                <h2>üå≤ Phase 2: Abstract Syntax Tree</h2>
                <div id="ast" class="ast-tree">
                    <p style="color: #999;">AST structure will appear here after compilation</p>
                </div>
            </div>
            
            <div class="panel">
                <h2>üîç Phase 3: Type Information</h2>
                <div id="types" class="output">
                    Type annotations will appear here after compilation
                </div>
            </div>
            
            <div class="panel full-width">
                <h2>‚öôÔ∏è Phase 4: Generated WebAssembly Code</h2>
                <div id="wasm" class="output">
                    WebAssembly text format (.wat) will appear here after compilation
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤—Å–µ –º–æ–¥—É–ª–∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ -->
    <script src="stage5-lexer.js"></script>
    <script src="stage5-parser.js"></script>
    <script src="stage5-type-analyzer.js"></script>
    <script src="stage5-wasm-generator.js"></script>
    <script src="stage5-compiler.js"></script>
    
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä
        let compiler = null;
        
        // –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞
        const examples = {
            add: `function add(a, b) {
    return a + b;
}`,
            factorial: `function factorial(n) {
    if (n <= 1) {
        return 1;
    }
    return n * factorial(n - 1);
}`,
            fibonacci: `function fibonacci(n) {
    if (n <= 1) {
        return n;
    }
    return fibonacci(n - 1) + fibonacci(n - 2);
}`,
            complex: `function calculate(x, y, z) {
    let result = x * 2 + y;
    if (result > 10) {
        result = result - z;
    }
    return result * result;
}`
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('DOMContentLoaded', () => {
            compiler = new window.CompilerStage5.Compiler();
            console.log('‚úì Compiler initialized and ready');
        });
        
        // –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
        async function compileCode() {
            const sourceCode = document.getElementById('sourceCode').value.trim();
            
            if (!sourceCode) {
                alert('Please enter some JavaScript code to compile');
                return;
            }
            
            updateStatus('compiling', 'Compiling...');
            clearOutputs();
            
            try {
                const results = await compiler.compile(sourceCode);
                
                displayResults(results);
                
                if (results.errors.length === 0) {
                    updateStatus('success', 'Compilation successful!');
                } else {
                    updateStatus('error', `Compilation completed with ${results.errors.length} error(s)`);
                }
                
            } catch (error) {
                updateStatus('error', 'Compilation failed: ' + error.message);
                console.error('Compilation error:', error);
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
        function displayResults(results) {
            // –¢–æ–∫–µ–Ω—ã
            displayTokens(results.tokens);
            
            // AST
            if (results.ast) {
                displayAST(results.ast);
            }
            
            // –¢–∏–ø–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            if (results.typedAst) {
                displayTypes(results.typedAst);
            }
            
            // WASM –∫–æ–¥
            if (results.watCode) {
                document.getElementById('wasm').textContent = results.watCode;
            }
            
            // –û—à–∏–±–∫–∏
            displayErrors(results.errors);
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const stats = compiler.getStats();
            document.getElementById('stat-tokens').textContent = stats.tokensGenerated;
            document.getElementById('stat-nodes').textContent = stats.astNodesCount;
            document.getElementById('stat-wat').textContent = stats.watLinesOfCode;
            document.getElementById('stat-errors').textContent = stats.errorsCount;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã
        function displayTokens(tokens) {
            const container = document.getElementById('tokens');
            container.innerHTML = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 50 —Ç–æ–∫–µ–Ω–æ–≤
            const tokensToShow = tokens.slice(0, 50);
            
            for (const token of tokensToShow) {
                const span = document.createElement('span');
                span.className = 'token ' + getTokenClass(token.type);
                span.textContent = token.type === 'EOF' ? 'EOF' : 
                                  (token.value || token.type);
                span.title = `${token.type} at ${token.line}:${token.column}`;
                container.appendChild(span);
            }
            
            if (tokens.length > 50) {
                const more = document.createElement('span');
                more.textContent = `... and ${tokens.length - 50} more tokens`;
                more.style.color = '#999';
                more.style.fontStyle = 'italic';
                container.appendChild(more);
            }
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç CSS –∫–ª–∞—Å—Å –¥–ª—è —Ç–æ–∫–µ–Ω–∞
        function getTokenClass(type) {
            const keywords = ['FUNCTION', 'RETURN', 'IF', 'ELSE', 'WHILE', 'FOR', 
                            'CONST', 'LET', 'VAR', 'TRUE', 'FALSE'];
            const operators = ['PLUS', 'MINUS', 'MULTIPLY', 'DIVIDE', 'ASSIGN', 
                             'EQUAL', 'LESS_THAN', 'GREATER_THAN'];
            const delimiters = ['LPAREN', 'RPAREN', 'LBRACE', 'RBRACE', 
                              'SEMICOLON', 'COMMA'];
            
            if (keywords.includes(type)) return 'token-keyword';
            if (type === 'IDENTIFIER') return 'token-identifier';
            if (type === 'NUMBER') return 'token-number';
            if (operators.includes(type)) return 'token-operator';
            if (delimiters.includes(type)) return 'token-delimiter';
            
            return 'token-operator';
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç AST
        function displayAST(ast) {
            const container = document.getElementById('ast');
            const formatted = compiler.formatAst(ast);
            container.textContent = formatted;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–∏–ø–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        function displayTypes(typedAst) {
            const container = document.getElementById('types');
            const formatted = compiler.formatAst(typedAst);
            container.textContent = formatted;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –æ—à–∏–±–∫–∏
        function displayErrors(errors) {
            const container = document.getElementById('errors');
            container.innerHTML = '';
            
            if (errors.length > 0) {
                for (const error of errors) {
                    const div = document.createElement('div');
                    div.className = 'error-message';
                    div.textContent = error;
                    container.appendChild(div);
                }
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å
        function updateStatus(type, message) {
            const statusIndicator = document.querySelector('.status-indicator');
            const statusText = document.getElementById('status-text');
            
            statusIndicator.className = 'status-indicator status-' + type;
            statusText.textContent = message;
        }
        
        // –û—á–∏—â–∞–µ—Ç –≤—Å–µ –≤—ã—Ö–æ–¥—ã
        function clearOutputs() {
            document.getElementById('tokens').innerHTML = '';
            document.getElementById('ast').textContent = 'Processing...';
            document.getElementById('types').textContent = 'Processing...';
            document.getElementById('wasm').textContent = 'Processing...';
            document.getElementById('errors').innerHTML = '';
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–∏–º–µ—Ä
        function loadExample(name) {
            if (examples[name]) {
                document.getElementById('sourceCode').value = examples[name];
            }
        }
        
        // –û—á–∏—â–∞–µ—Ç –≤—Å—ë
        function clearAll() {
            document.getElementById('sourceCode').value = '';
            clearOutputs();
            document.getElementById('stat-tokens').textContent = '0';
            document.getElementById('stat-nodes').textContent = '0';
            document.getElementById('stat-wat').textContent = '0';
            document.getElementById('stat-errors').textContent = '0';
            updateStatus('idle', 'Ready to compile');
        }
    </script>
</body>
</html>
